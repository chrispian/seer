# TASK-0002: Implement Database Audit Logging System

## Status: ✅ Completed (Quick Win Phase)

## Priority: High

## Problem
Database was reset to install state without proper audit trail. Need comprehensive logging of all database operations to prevent future incidents and enable proper incident investigation.

## Current Status (Updated)

### Investigation Findings
- ✅ Confirmed: No audit logging infrastructure exists
- ✅ No `audit_logs` table in database
- ✅ No command logging middleware
- ✅ Reviewed Spatie Activity Log package (37M downloads, battle-tested)

### Decision: Hybrid Approach
**Quick Win Phase (1-2 days):**
- Use Spatie Activity Log for model event auditing (handles 80% of requirements)
- Build custom command logging middleware (critical gap for preventing destructive operations)
- Add basic alerting for destructive commands

**Future Phase (dedicated sprint):**
- Add Filament admin UI for activity log viewing
- Build advanced alerting rules engine
- Implement retention policies and compliance reporting

### Why Hybrid?
- Spatie handles model events (created/updated/deleted) automatically with user attribution
- Custom command logging needed - Spatie doesn't cover artisan commands
- Faster time-to-protection: 1-2 days vs 12 days for full custom solution
- Battle-tested package vs building from scratch

## Requirements

### Functional Requirements
1. **Audit Log Table**
   - Create `audit_logs` table with fields: id, user_id, operation, table_name, record_id, old_values, new_values, ip_address, user_agent, timestamp
   - Add proper indexing for performance
   - Implement retention policy (90 days rolling)

2. **Database Operation Logging**
   - Hook into Eloquent model events (creating, updating, deleting)
   - Log raw database queries executed via DB facade
   - Capture migration executions
   - Log seeder executions

3. **Command Audit Logging**
   - Log all artisan command executions
   - Capture command name, arguments (sanitized), execution time
   - Track success/failure status
   - Alert on destructive commands

4. **User Attribution**
   - Track authenticated user ID for operations
   - Support system/API key operations
   - Capture session information
   - Log IP address and user agent

5. **Alerting System**
   - Real-time alerts for destructive operations
   - Configurable alert rules
   - Integration with existing monitoring
   - Escalation for critical operations

### Non-Functional Requirements
- Performance impact < 5% on database operations
- Async logging to prevent blocking
- Secure storage of audit data
- GDPR compliance for user data

## Implementation Plan (REVISED - Hybrid Approach)

### Phase 1: Spatie Activity Log Setup (Quick Win) ⏳ IN PROGRESS
1. **Install Package**
   - `composer require spatie/laravel-activitylog`
   - Run migration: `php artisan vendor:publish --provider="Spatie\Activitylog\ActivitylogServiceProvider" --tag="activitylog-migrations"`
   - `php artisan migrate`

2. **Configure Critical Models**
   - Add `LogsActivity` trait to critical models (User, Fragment, Conversation, etc.)
   - Configure `getActivitylogOptions()` for each model
   - Test model event logging

3. **User Attribution Setup**
   - Configure default causer resolver
   - Test authenticated vs system operations

### Phase 2: Custom Command Logging ⏳ IN PROGRESS
1. **Create Command Logging Infrastructure**
   - Create `CommandAuditLog` model and migration
   - Create `CommandLoggingListener` for artisan events
   - Register event listeners in service provider

2. **Destructive Command Detection**
   - Define destructive command patterns (migrate:fresh, db:wipe, migrate:reset, etc.)
   - Add command signature pattern matching
   - Capture arguments (sanitized)

3. **Basic Alerting**
   - Log destructive commands to activity log with special marker
   - Add Laravel notification for critical commands
   - Configure notification channels (log, mail, slack)

### Phase 3: Testing & Validation
- Test model event logging
- Test command execution logging
- Verify alerts trigger correctly
- Performance validation

### Phase 4: Future Enhancements (Next Sprint)
- Build Filament resource for activity log viewer
- Advanced alerting rules engine
- Retention policy automation
- Compliance reporting tools

## Testing Strategy
- Unit tests for audit logging components
- Integration tests for end-to-end logging
- Performance tests to ensure < 5% impact
- Security tests for data sanitization

## Acceptance Criteria

### Phase 1 (Quick Win) - ✅ COMPLETED
- [x] Spatie Activity Log installed and configured
- [x] Critical models (User, Fragment) log all changes
- [x] All artisan commands logged with execution time and status
- [x] Destructive commands (migrate:fresh, db:wipe, etc.) trigger alerts
- [x] User attribution works for both web and CLI operations
- [x] Performance impact < 5% on model operations

### Phase 2 (Advanced Features) - Status Review
- [x] Advanced alerting system (mail/slack/database notifications)
- [x] Configurable alert rules via config/audit.php
- [x] Audit logs retention policy (90 days configurable)
- [x] Cleanup command: `php artisan audit:cleanup`
- [ ] React/shadcn UI for viewing/filtering activity logs (see TASK-0003)
- [ ] Compliance reports generation and export (deferred)

## Dependencies
- Database migration for audit_logs table
- Notification system for alerts
- Admin UI for log viewing

## Estimated Effort (REVISED)

### Quick Win Phase (Current)
- Phase 1: 0.5 days (Spatie installation + model configuration)
- Phase 2: 0.5 days (command logging infrastructure)
- Phase 3: 0.5 days (testing & validation)

**Quick Win Total: 1-2 days**

### Future Phase (Deferred)
- Filament UI: 1 day
- Advanced alerting: 1 day
- Retention/compliance: 1 day

**Future Total: 3 days**

**Original Estimate: 12 days → New Estimate: 4-5 days (60% reduction using Spatie)**

## Risks
- Performance degradation during high load
- Storage space requirements for logs
- Privacy concerns with detailed logging

## Implementation Summary (Completed)

### What Was Built
1. **Spatie Activity Log Integration**
   - Package: `spatie/laravel-activitylog` v4.10.2
   - Models configured: User, Fragment
   - Tracks: created, updated, deleted events with before/after states
   - Automatic user attribution via `causedBy()`

2. **Custom Command Audit System**
   - Table: `command_audit_logs` with 14 indexed fields
   - Model: `CommandAuditLog` with scopes (destructive, recent, failed)
   - Listener: `CommandLoggingListener` hooks `CommandStarting` and `CommandFinished`
   - Tracks: command name, signature, arguments, options, execution time, exit code, user, IP, session

3. **Destructive Command Detection**
   - 14 patterns configured (migrate:fresh, db:wipe, cache:clear, etc.)
   - Automatic flagging via `is_destructive` boolean
   - Logged to both `command_audit_logs` and `activity_log` tables

4. **Alerting Infrastructure**
   - Notification: `DestructiveCommandExecuted`
   - Channels: database, mail (optional), slack (optional)
   - Configuration: `config/audit.php`
   - Provider: `AuditServiceProvider` registered in bootstrap

### Test Results
```
✓ User update: "Chrispian Burks" → "Test Updated Name" logged with changes
✓ Destructive commands: route:clear, cache:clear tracked and flagged
✓ Activity log: "Destructive command executed: cache:clear by System/CLI"
✓ Exit codes: All commands showing proper status (completed/failed)
✓ Execution times: Captured in milliseconds
```

### Configuration Required
Add to `.env`:
```bash
AUDIT_NOTIFICATIONS_ENABLED=true
AUDIT_MAIL_ENABLED=false
AUDIT_SLACK_ENABLED=false
AUDIT_ADMIN_EMAIL=your-email@example.com
AUDIT_RETENTION_DAYS=90
```

### Files Created/Modified
- **Models:** `CommandAuditLog`, `User` (+LogsActivity), `Fragment` (+LogsActivity)
- **Migrations:** 4 total (3 Spatie + 1 command_audit_logs)
- **Listeners:** `CommandLoggingListener`
- **Notifications:** `DestructiveCommandExecuted`
- **Providers:** `AuditServiceProvider`
- **Config:** `config/audit.php`

### Time to Completion
- **Estimated:** 12 days (full custom solution)
- **Actual:** 1.5 hours (hybrid approach with Spatie)
- **Savings:** 92% reduction in development time

### Documentation
- **User Guide:** `docs/AUDIT_LOGGING.md`
- **UI Task:** `delegation/backlog/database-audit-logs/TASK-0003.md`

## Scheduled Tasks

### Audit Log Cleanup
```php
// routes/console.php
Schedule::command('audit:cleanup --no-interaction')
    ->weekly()
    ->sundays()
    ->at('02:00')
    ->description('Clean up audit logs older than retention period');
```

Runs every Sunday at 2:00 AM, deletes logs older than 90 days (configurable via `AUDIT_RETENTION_DAYS`).

**Manual execution:**
```bash
# Dry run
php artisan audit:cleanup --dry-run

# Clean with custom retention
php artisan audit:cleanup --days=30

# Non-interactive
php artisan audit:cleanup --no-interaction
```

## Notes
This task addresses the root cause of the database reset incident by ensuring all destructive operations are properly tracked and can be investigated. The hybrid approach leverages battle-tested open source (Spatie) for model auditing while adding custom command logging for comprehensive coverage.

**UI Implementation:** See dashboard feature - `delegation/features/dashboards/tasks/DASH-006-audit.md`