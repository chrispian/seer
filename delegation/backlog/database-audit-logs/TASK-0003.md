# TASK-0003: Audit Logs UI (React/shadcn)

## Status: Backlog

## Priority: Medium

## Problem
While the audit logging backend is complete, there is no user interface for administrators to view, search, and filter audit logs. Need a React-based UI to make audit data accessible and actionable.

## Requirements

### Functional Requirements
1. **Activity Log Viewer**
   - Display recent activity from `activity_log` table
   - Show: timestamp, user, action, model type, description, changes
   - Paginated table with sorting
   - Real-time updates (optional websockets)

2. **Command Audit Log Viewer**
   - Display recent commands from `command_audit_logs` table
   - Show: timestamp, command, user, status, exit code, execution time
   - Highlight destructive commands
   - Filter by status (completed/failed/running)

3. **Search & Filtering**
   - Filter by date range
   - Filter by user
   - Filter by event type (created/updated/deleted/destructive_command)
   - Filter by model type
   - Full-text search on descriptions
   - Filter destructive commands only

4. **Detail Views**
   - Click row to expand and show:
     - Full before/after changes (JSON diff viewer)
     - Complete command signature with arguments
     - Full error output for failed commands
     - Related activities (group by batch_uuid)
   - Export single log entry as JSON

5. **Dashboard/Stats**
   - Recent destructive commands (last 7 days)
   - Failed commands count
   - Most active users
   - Activity by model type (pie chart)
   - Timeline chart of activities

### Non-Functional Requirements
- Performance: Handle 10k+ log entries smoothly
- Responsive design (mobile-friendly tables)
- Accessible (WCAG 2.1 AA)
- Real-time updates via polling or websockets

## Technical Specifications

### Backend API Endpoints Needed
Create new API controller: `app/Http/Controllers/Api/AuditLogController.php`

```php
GET  /api/audit/activities
  - Query params: page, per_page, sort, order, user_id, event, model_type, search, date_from, date_to
  - Returns: paginated activity logs with causer relationship

GET  /api/audit/activities/{id}
  - Returns: single activity with full details

GET  /api/audit/commands
  - Query params: page, per_page, sort, order, user_id, status, is_destructive, date_from, date_to
  - Returns: paginated command logs with user relationship

GET  /api/audit/commands/{id}
  - Returns: single command log with full details

GET  /api/audit/stats
  - Returns: dashboard statistics (counts, charts data)
```

### Frontend Components (React/shadcn)

**Page Structure:**
```
resources/js/pages/AuditLogs/
├── index.tsx              # Main page with tabs
├── ActivityLogTable.tsx   # Activity log data table
├── CommandLogTable.tsx    # Command log data table
├── LogDetailDialog.tsx    # Expandable detail view
├── LogFilters.tsx         # Shared filter controls
├── AuditStats.tsx         # Dashboard cards
└── hooks/
    ├── useActivityLogs.ts # React Query hook for activities
    ├── useCommandLogs.ts  # React Query hook for commands
    └── useAuditStats.ts   # React Query hook for stats
```

**shadcn/ui Components to Use:**
- `Table` - Data tables
- `Card` - Stats dashboard
- `Badge` - Status indicators (destructive, failed, success)
- `Dialog` - Detail view modal
- `Select` - Filter dropdowns
- `Input` - Search and date inputs
- `Button` - Actions (export, refresh, etc.)
- `Tabs` - Switch between Activity/Commands/Stats
- `Separator` - Visual dividers
- `ScrollArea` - Long content areas
- `Skeleton` - Loading states

**Key Features to Implement:**
1. **JSON Diff Viewer** for before/after changes
   - Consider: `react-diff-viewer-continued` or `diff2html`
   
2. **Code Syntax Highlighting** for commands
   - Consider: `prism-react-renderer` or `react-syntax-highlighter`

3. **Date Range Picker**
   - shadcn/ui doesn't have one - use `react-day-picker` with shadcn styling

4. **Export Functionality**
   - Export filtered results as CSV or JSON
   - Use browser download APIs

## UI Mockup / Wireframe

```
┌─────────────────────────────────────────────────────────────┐
│  Audit Logs                                    [Refresh] [⚙]│
├─────────────────────────────────────────────────────────────┤
│  [Activity Logs] [Command Logs] [Statistics]                │
├─────────────────────────────────────────────────────────────┤
│  Filters:                                                    │
│  [Date Range ▼] [User ▼] [Event ▼] [Search__________] [Go] │
├─────────────────────────────────────────────────────────────┤
│  Time       User      Event      Model       Description    │
│  ────────────────────────────────────────────────────────── │
│  12:26 PM   System    deleted    Fragment    Deleted fra... │
│  12:25 PM   Admin     updated    User        Updated use... │
│  12:20 PM   System    ⚠️ destru.. Command    Executed ca... │
│  ...                                                         │
├─────────────────────────────────────────────────────────────┤
│  Showing 1-50 of 1,234          [< Prev] Page 1 [Next >]   │
└─────────────────────────────────────────────────────────────┘

Detail Dialog (on row click):
┌─────────────────────────────────────────────────────────────┐
│  Activity Details                                      [✕]  │
├─────────────────────────────────────────────────────────────┤
│  Timestamp: 2025-10-09 12:25:00                             │
│  User: Admin (chrispian@example.com)                        │
│  Event: updated                                              │
│  Model: User #1                                              │
│  IP Address: 127.0.0.1                                       │
│                                                              │
│  Changes:                                                    │
│  ┌────────────────────────────────────────────────────────┐ │
│  │ Old Value          │ New Value                         │ │
│  │ ─────────────────────────────────────────────────────  │ │
│  │ "Chrispian Burks"  │ "Test Updated Name"              │ │
│  └────────────────────────────────────────────────────────┘ │
│                                                              │
│  [Export JSON] [Copy Link]                                  │
└─────────────────────────────────────────────────────────────┘
```

## Implementation Checklist

### Backend
- [ ] Create `AuditLogController` with all endpoints
- [ ] Add API routes to `routes/api.php`
- [ ] Create API resources: `ActivityLogResource`, `CommandLogResource`
- [ ] Add query scopes to models for filtering
- [ ] Add pagination support
- [ ] Test API endpoints with Postman/Insomnia

### Frontend
- [ ] Create page route in React Router
- [ ] Build `AuditLogs/index.tsx` with tabs
- [ ] Implement `ActivityLogTable` with shadcn Table
- [ ] Implement `CommandLogTable` with shadcn Table
- [ ] Create `LogDetailDialog` component
- [ ] Create `LogFilters` component
- [ ] Implement React Query hooks for data fetching
- [ ] Add JSON diff viewer for changes
- [ ] Add syntax highlighting for commands
- [ ] Implement export functionality
- [ ] Build statistics dashboard
- [ ] Add loading states and error handling
- [ ] Add mobile responsive styling
- [ ] Test accessibility with screen reader

### Integration
- [ ] Add navigation menu item for Audit Logs
- [ ] Add permission checks (admin only)
- [ ] Test with real audit data
- [ ] Add polling for real-time updates (optional)
- [ ] Add websocket support (optional)

## Acceptance Criteria
- [ ] Admins can view paginated activity logs with all fields
- [ ] Admins can view paginated command logs with all fields
- [ ] All filters work correctly and can be combined
- [ ] Search returns relevant results
- [ ] Detail view shows complete before/after changes
- [ ] Destructive commands are visually highlighted
- [ ] Failed commands show error output
- [ ] Statistics dashboard shows accurate data
- [ ] Export functionality works for JSON
- [ ] UI is responsive on mobile devices
- [ ] Page loads and filters perform well with 10k+ records

## Technical Notes

### React Query Setup
```typescript
// useActivityLogs.ts
export function useActivityLogs(filters: ActivityLogFilters) {
  return useQuery({
    queryKey: ['activityLogs', filters],
    queryFn: () => fetchActivityLogs(filters),
    refetchInterval: 30000, // Poll every 30s
  });
}
```

### API Response Format
```json
{
  "data": [
    {
      "id": 123,
      "description": "updated",
      "subject_type": "App\\Models\\User",
      "subject_id": 1,
      "causer_type": "App\\Models\\User",
      "causer_id": 1,
      "causer": {
        "id": 1,
        "name": "Admin",
        "email": "admin@example.com"
      },
      "properties": {
        "attributes": { "name": "New Name" },
        "old": { "name": "Old Name" }
      },
      "event": "updated",
      "created_at": "2025-10-09T12:25:00Z"
    }
  ],
  "links": { ... },
  "meta": { "current_page": 1, "total": 1234, ... }
}
```

### Component Library References
- shadcn/ui docs: https://ui.shadcn.com/
- React Query: https://tanstack.com/query/latest
- React Router: https://reactrouter.com/
- date-fns (for date formatting): https://date-fns.org/

## Estimated Effort
- Backend API: 0.5 days
- Frontend components: 2 days
- Styling & polish: 0.5 days
- Testing: 0.5 days

**Total: 3-4 days**

## Dependencies
- Audit logging backend (TASK-0002) - ✅ COMPLETED
- React/shadcn UI framework already in use
- API authentication middleware

## Out of Scope
- Real-time websocket updates (can be added later)
- Bulk operations (delete multiple logs)
- Advanced analytics (time-series charts, trends)
- Log export to external systems (SIEM, etc.)
